# Migration `20200923051655`

This migration has been generated by Conner Petzold at 9/22/2020, 10:16:55 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."Game" DROP COLUMN "reportedAt"

ALTER TABLE "public"."Player" DROP COLUMN "snapshotRating",
DROP COLUMN "ratingChange"

ALTER TABLE "public"."Rank" ALTER COLUMN "rating" SET DEFAULT 0,
ALTER COLUMN "ratingDeviation" SET DEFAULT 0,
ALTER COLUMN "ratingVolatility" SET DEFAULT 0

ALTER TABLE "public"."User" ADD COLUMN "isAdmin" boolean   NOT NULL DEFAULT false

CREATE TABLE "public"."RankState" (
"userId" text   NOT NULL ,
"leagueId" text   NOT NULL ,
"gameId" text   NOT NULL ,
"gameStartedAt" timestamp(3)   NOT NULL ,
"rating" Decimal(65,30)   NOT NULL DEFAULT 0,
"ratingChange" Decimal(65,30)   NOT NULL DEFAULT 0,
"ratingDeviation" Decimal(65,30)   NOT NULL DEFAULT 0,
"ratingVolatility" Decimal(65,30)   NOT NULL DEFAULT 0,
"wins" integer   NOT NULL DEFAULT 0,
"losses" integer   NOT NULL DEFAULT 0,
PRIMARY KEY ("userId","gameId")
)

ALTER TABLE "public"."RankState" ADD FOREIGN KEY ("userId", "leagueId")REFERENCES "public"."Rank"("userId","leagueId") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."RankState" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."RankState" ADD FOREIGN KEY ("leagueId")REFERENCES "public"."League"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."RankState" ADD FOREIGN KEY ("gameId")REFERENCES "public"."Game"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200910050639..20200923051655
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator prisma_client {
   provider        = "prisma-client-js"
@@ -15,25 +15,27 @@
   email       String   @unique
   password    String
   countryCode String?
   avatar      String?
+  isAdmin     Boolean  @default(false)
   ranks       Rank[]
   playedGames Player[]
+  rankStates  RankState[]
 }
 model Game {
-  id         String   @default(uuid()) @id
-  createdAt  DateTime @default(now())
-  reportedAt DateTime
+  id         String      @default(uuid()) @id
+  createdAt  DateTime    @default(now())
   startedAt  DateTime
   duration   Int
   players    Player[]
-  league     League   @relation(fields: [leagueId], references: [id])
+  league     League      @relation(fields: [leagueId], references: [id])
   leagueId   String
   replayHash String?
   replayUrl  String
   logUrl     String
+  rankStates RankState[]
 }
 model Player {
   createdAt   DateTime @default(now())
@@ -49,33 +51,54 @@
   turnCount   Int
   turnTime    Int
   retreatTime Int
-  snapshotRating Float?
-  ratingChange   Float?
-
   @@id([userId, gameId])
 }
 model League {
-  id    String @default(uuid()) @id
-  name  String
-  ranks Rank[]
-  games Game[]
+  id         String      @default(uuid()) @id
+  name       String
+  ranks      Rank[]
+  games      Game[]
+  rankStates RankState[]
 }
 model Rank {
   user     User   @relation(fields: [userId], references: [id])
   userId   String
   league   League @relation(fields: [leagueId], references: [id])
   leagueId String
-  rating           Float
-  ratingDeviation  Float
-  ratingVolatility Float
+  rating           Float @default(0)
+  ratingDeviation  Float @default(0)
+  ratingVolatility Float @default(0)
-  wins        Int      @default(0)
-  losses      Int      @default(0)
+  wins   Int @default(0)
+  losses Int @default(0)
+
+  states      RankState[]
   playedGames Player[]
   @@id([userId, leagueId])
 }
+
+model RankState {
+  rank          Rank     @relation(fields: [userId, leagueId], references: [userId, leagueId])
+  user          User     @relation(fields: [userId], references: [id])
+  userId        String
+  league        League   @relation(fields: [leagueId], references: [id])
+  leagueId      String
+  game          Game     @relation(fields: [gameId], references: [id])
+  gameId        String
+  gameStartedAt DateTime
+
+  rating           Float @default(0)
+  ratingChange     Float @default(0)
+  ratingDeviation  Float @default(0)
+  ratingVolatility Float @default(0)
+
+  wins   Int @default(0)
+  losses Int @default(0)
+
+  @@id([userId, gameId])
+}
```


